package main

import (
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func TestParse(t *testing.T) {
	timestamp := time.Date(2021, time.November, 1, 3, 0, 0, 0, time.UTC)
	b, err := parse("host", "service", 0, "", variableFlags{"a=xyz", "b=23", "c=asd"}, "/=2643MB;5948;5958;0;5968 /boot=68MB;88;93;0;98", timestamp)
	assert.Nil(t, err)

	expected := "metric,label=/,host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2643,warn=5948,crit=5958,min=0,max=5968 1635735600000000000\nmetric,label=/boot,host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=68,warn=88,crit=93,min=0,max=98 1635735600000000000\nstate,host=host,service=service,a=xyz,b=23,c=asd value=0i 1635735600000000000\n"
	assert.Equal(t, expected, b.String())
}

func TestLongPerfdata(t *testing.T) {
	timestamp := time.Date(2021, time.November, 1, 3, 0, 0, 0, time.UTC)
	b, err := parse("host", "service", 0, "", variableFlags{"a=xyz", "b=23", "c=asd"}, "'tbs_data_tbs_usage_pct'=76.56%;90;95 'tbs_data_tbs_usage'=1097524MB;1290240;1361920;0;1433600 'tbs_data_tbs_alloc'=1331200MB;;;0;1433600 'tbs_index_tbs_usage_pct'=71.02%;90;95 'tbs_index_tbs_usage'=509048MB;645120;680960;0;716800 'tbs_index_tbs_alloc'=542720MB;;;0;716800 'tbs_data3_usage_pct'=67.97%;90;95 'tbs_data3_usage'=696MB;921;972;0;1024 'tbs_data3_alloc'=750MB;;;0;1024 'tbs_ordertrld_tbs_usage_pct'=62.79%;90;95 'tbs_ordertrld_tbs_usage'=124946MB;171000;180500;0;190000 'tbs_ordertrld_tbs_alloc'=199000MB;;;0;190000 'tbs_audittbs_usage_pct'=58.76%;90;95 'tbs_audittbs_usage'=705095MB;1080000;1140000;0;1200000 'tbs_audittbs_alloc'=1075000MB;;;0;1200000 'tbs_sysaux_usage_pct'=36.75%;90;95 'tbs_sysaux_usage'=60202MB;147451;155643;0;163834 'tbs_sysaux_alloc'=124475MB;;;0;163834 'tbs_data1_usage_pct'=32.08%;90;95 'tbs_data1_usage'=10510MB;29491;31129;0;32768 'tbs_data1_alloc'=17400MB;;;0;32768 'tbs_bdc_usage_pct'=21.39%;90;95 'tbs_bdc_usage'=63086MB;265420;280166;0;294911 'tbs_bdc_alloc'=275161MB;;;0;294911 'tbs_sapindex01_usage_pct'=13.68%;90;95 'tbs_sapindex01_usage'=4482MB;29491;31129;0;32768 'tbs_sapindex01_alloc'=7650MB;;;0;32768 'tbs_sapdata01_usage_pct'=11.86%;90;95 'tbs_sapdata01_usage'=3886MB;29491;31129;0;32768 'tbs_sapdata01_alloc'=8550MB;;;0;32768 'tbs_archd01_usage_pct'=12.08%;90;95 'tbs_archd01_usage'=123MB;921;972;0;1024 'tbs_archd01_alloc'=250MB;;;0;1024 'tbs_data01_usage_pct'=10.21%;90;95 'tbs_data01_usage'=62759MB;552960;583680;0;614400 'tbs_data01_alloc'=480152MB;;;0;614400 'tbs_users_usage_pct'=5.71%;90;95 'tbs_users_usage'=2924MB;46080;48640;0;51200 'tbs_users_alloc'=3460MB;;;0;51200 'tbs_system_usage_pct'=4.97%;90;95 'tbs_system_usage'=1528MB;27648;29184;0;30720 'tbs_system_alloc'=1536MB;;;0;30720 'tbs_crm_loyalty_usage_pct'=4.97%;90;95 'tbs_crm_loyalty_usage'=1628MB;29491;31129;0;32768 'tbs_crm_loyalty_alloc'=3150MB;;;0;32768 'tbs_del_cust_usage_pct'=3.95%;90;95 'tbs_del_cust_usage'=2019MB;46080;48640;0;51200 'tbs_del_cust_alloc'=2120MB;;;0;51200 'tbs_crm_loyaltyidx_usage_pct'=2.96%;90;95 'tbs_crm_loyaltyidx_usage'=969MB;29491;31129;0;32768 'tbs_crm_loyaltyidx_alloc'=1250MB;;;0;32768 'tbs_ipsoft_usage_pct'=1.31%;90;95 'tbs_ipsoft_usage'=1MB;90;95;0;100 'tbs_ipsoft_alloc'=100MB;;;0;100 'tbs_bmc_dev_ts_usage_pct'=0.10%;90;95 'tbs_bmc_dev_ts_usage'=1MB;921;972;0;1024 'tbs_bmc_dev_ts_alloc'=50MB;;;0;1024 'tbs_cleaning_usage_pct'=0.10%;90;95 'tbs_cleaning_usage'=1MB;921;972;0;1024 'tbs_cleaning_alloc'=50MB;;;0;1024 'tbs_data10_usage_pct'=0.10%;90;95 'tbs_data10_usage'=1MB;921;972;0;1024 'tbs_data10_alloc'=50MB;;;0;1024 'tbs_documentai_tbs_usage_pct'=0.10%;90;95 'tbs_documentai_tbs_usage'=1MB;921;972;0;1024 'tbs_documentai_tbs_alloc'=50MB;;;0;1024 'tbs_index10_usage_pct'=0.10%;90;95 'tbs_index10_usage'=1MB;921;972;0;1024 'tbs_index10_alloc'=50MB;;;0;1024 'tbs_reorg_usage_pct'=0.00%;90;95 'tbs_reorg_usage'=1MB;29491;31129;0;32768 'tbs_reorg_alloc'=950MB;;;0;32768 'tbs_t_customer_usage_pct'=0.10%;90;95 'tbs_t_customer_usage'=1MB;921;972;0;1024 'tbs_t_customer_alloc'=300MB;;;0;1024 'tbs_crm_bcl_data_usage_pct'=0.10%;90;95 'tbs_crm_bcl_data_usage'=1MB;921;972;0;1024 'tbs_crm_bcl_data_alloc'=50MB;;;0;1024 'tbs_documentad_tbs_usage_pct'=0.10%;90;95 'tbs_documentad_tbs_usage'=1MB;921;972;0;1024 'tbs_documentad_tbs_alloc'=50MB;;;0;1024 'tbs_logmgr_usage_pct'=0.10%;90;95 'tbs_logmgr_usage'=1MB;921;972;0;1024 'tbs_logmgr_alloc'=50MB;;;0;1024 'tbs_tax_index01_usage_pct'=0.10%;90;95 'tbs_tax_index01_usage'=1MB;921;972;0;1024 'tbs_tax_index01_alloc'=50MB;;;0;1024 'tbs_ordertrli_tbs_usage_pct'=0.10%;90;95 'tbs_ordertrli_tbs_usage'=1MB;921;972;0;1024 'tbs_ordertrli_tbs_alloc'=50MB;;;0;1024 'tbs_gunowak_usage_pct'=0.00%;90;95 'tbs_gunowak_usage'=1MB;29491;31129;0;32768 'tbs_gunowak_alloc'=2058MB;;;0;32768 'tbs_data4_usage_pct'=0.10%;90;95 'tbs_data4_usage'=1MB;921;972;0;1024 'tbs_data4_alloc'=50MB;;;0;1024 'tbs_err_data_usage_pct'=0.10%;90;95 'tbs_err_data_usage'=1MB;921;972;0;1024 'tbs_err_data_alloc'=50MB;;;0;1024 'tbs_err_index_usage_pct'=0.10%;90;95 'tbs_err_index_usage'=1MB;921;972;0;1024 'tbs_err_index_alloc'=50MB;;;0;1024 'tbs_index03_usage_pct'=0.10%;90;95 'tbs_index03_usage'=1MB;921;972;0;1024 'tbs_index03_alloc'=50MB;;;0;1024 'tbs_index04_usage_pct'=0.10%;90;95 'tbs_index04_usage'=1MB;921;972;0;1024 'tbs_index04_alloc'=50MB;;;0;1024 'tbs_cic_usage_pct'=0.10%;90;95 'tbs_cic_usage'=1MB;921;972;0;1024 'tbs_cic_alloc'=50MB;;;0;1024 'tbs_index51_usage_pct'=0.10%;90;95 'tbs_index51_usage'=1MB;921;972;0;1024 'tbs_index51_alloc'=50MB;;;0;1024 'tbs_leander_usage_pct'=0.10%;90;95 'tbs_leander_usage'=1MB;921;972;0;1024 'tbs_leander_alloc'=50MB;;;0;1024 'tbs_imadvisor_usage_pct'=0.12%;90;95 'tbs_imadvisor_usage'=186MB;138240;145920;0;153600 'tbs_imadvisor_alloc'=1024MB;;;0;153600 'tbs_crm_bcl_index_usage_pct'=0.10%;90;95 'tbs_crm_bcl_index_usage'=1MB;921;972;0;1024 'tbs_crm_bcl_index_alloc'=50MB;;;0;1024 'tbs_eds_discover_usage_pct'=0.10%;90;95 'tbs_eds_discover_usage'=1MB;921;972;0;1024 'tbs_eds_discover_alloc'=50MB;;;0;1024 'tbs_index01_usage_pct'=0.10%;90;95 'tbs_index01_usage'=1MB;921;972;0;1024 'tbs_index01_alloc'=50MB;;;0;1024 'tbs_logmgridx_usage_pct'=0.10%;90;95 'tbs_logmgridx_usage'=1MB;921;972;0;1024 'tbs_logmgridx_alloc'=50MB;;;0;1024 'tbs_ordtrl01_usage_pct'=0.10%;90;95 'tbs_ordtrl01_usage'=1MB;921;972;0;1024 'tbs_ordtrl01_alloc'=50MB;;;0;1024 'tbs_ordtrl02_usage_pct'=0.10%;90;95 'tbs_ordtrl02_usage'=1MB;921;972;0;1024 'tbs_ordtrl02_alloc'=50MB;;;0;1024 'tbs_tax_data01_usage_pct'=0.10%;90;95 'tbs_tax_data01_usage'=1MB;921;972;0;1024 'tbs_tax_data01_alloc'=50MB;;;0;1024 'tbs_dashboard_usage_pct'=0.00%;90;95 'tbs_dashboard_usage'=1MB;29490;31128;0;32767 'tbs_dashboard_alloc'=100MB;;;0;32767 'tbs_index02_usage_pct'=0.10%;90;95 'tbs_index02_usage'=1MB;921;972;0;1024 'tbs_index02_alloc'=50MB;;;0;1024 'tbs_ordtrli01_usage_pct'=0.10%;90;95 'tbs_ordtrli01_usage'=1MB;921;972;0;1024 'tbs_ordtrli01_alloc'=50MB;;;0;1024", timestamp)
	assert.Nil(t, err)

	expected := "metric,label='tbs_data_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=76.56,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1097524,warn=1290240,crit=1361920,min=0,max=1433600 1635735600000000000\nmetric,label='tbs_data_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1331200,min=0,max=1433600 1635735600000000000\nmetric,label='tbs_index_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=71.02,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=509048,warn=645120,crit=680960,min=0,max=716800 1635735600000000000\nmetric,label='tbs_index_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=542720,min=0,max=716800 1635735600000000000\nmetric,label='tbs_data3_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=67.97,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data3_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=696,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_data3_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=750,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordertrld_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=62.79,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ordertrld_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=124946,warn=171000,crit=180500,min=0,max=190000 1635735600000000000\nmetric,label='tbs_ordertrld_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=199000,min=0,max=190000 1635735600000000000\nmetric,label='tbs_audittbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=58.76,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_audittbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=705095,warn=1080000,crit=1140000,min=0,max=1200000 1635735600000000000\nmetric,label='tbs_audittbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1075000,min=0,max=1200000 1635735600000000000\nmetric,label='tbs_sysaux_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=36.75,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_sysaux_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=60202,warn=147451,crit=155643,min=0,max=163834 1635735600000000000\nmetric,label='tbs_sysaux_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=124475,min=0,max=163834 1635735600000000000\nmetric,label='tbs_data1_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=32.08,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data1_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=10510,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_data1_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=17400,min=0,max=32768 1635735600000000000\nmetric,label='tbs_bdc_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=21.39,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_bdc_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=63086,warn=265420,crit=280166,min=0,max=294911 1635735600000000000\nmetric,label='tbs_bdc_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=275161,min=0,max=294911 1635735600000000000\nmetric,label='tbs_sapindex01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=13.68,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_sapindex01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=4482,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_sapindex01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=7650,min=0,max=32768 1635735600000000000\nmetric,label='tbs_sapdata01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=11.86,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_sapdata01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=3886,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_sapdata01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=8550,min=0,max=32768 1635735600000000000\nmetric,label='tbs_archd01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=12.08,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_archd01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=123,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_archd01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=250,min=0,max=1024 1635735600000000000\nmetric,label='tbs_data01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=10.21,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=62759,warn=552960,crit=583680,min=0,max=614400 1635735600000000000\nmetric,label='tbs_data01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=480152,min=0,max=614400 1635735600000000000\nmetric,label='tbs_users_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=5.71,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_users_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2924,warn=46080,crit=48640,min=0,max=51200 1635735600000000000\nmetric,label='tbs_users_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=3460,min=0,max=51200 1635735600000000000\nmetric,label='tbs_system_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=4.97,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_system_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1528,warn=27648,crit=29184,min=0,max=30720 1635735600000000000\nmetric,label='tbs_system_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1536,min=0,max=30720 1635735600000000000\nmetric,label='tbs_crm_loyalty_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=4.97,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_crm_loyalty_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1628,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_crm_loyalty_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=3150,min=0,max=32768 1635735600000000000\nmetric,label='tbs_del_cust_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=3.95,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_del_cust_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2019,warn=46080,crit=48640,min=0,max=51200 1635735600000000000\nmetric,label='tbs_del_cust_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2120,min=0,max=51200 1635735600000000000\nmetric,label='tbs_crm_loyaltyidx_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=2.96,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_crm_loyaltyidx_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=969,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_crm_loyaltyidx_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1250,min=0,max=32768 1635735600000000000\nmetric,label='tbs_ipsoft_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=1.31,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ipsoft_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=90,crit=95,min=0,max=100 1635735600000000000\nmetric,label='tbs_ipsoft_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=100,min=0,max=100 1635735600000000000\nmetric,label='tbs_bmc_dev_ts_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_bmc_dev_ts_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_bmc_dev_ts_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_cleaning_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_cleaning_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_cleaning_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_data10_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data10_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_data10_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_documentai_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_documentai_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_documentai_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index10_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index10_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index10_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_reorg_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_reorg_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_reorg_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=950,min=0,max=32768 1635735600000000000\nmetric,label='tbs_t_customer_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_t_customer_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_t_customer_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=300,min=0,max=1024 1635735600000000000\nmetric,label='tbs_crm_bcl_data_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_crm_bcl_data_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_crm_bcl_data_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_documentad_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_documentad_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_documentad_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_logmgr_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_logmgr_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_logmgr_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_tax_index01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_tax_index01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_tax_index01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordertrli_tbs_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ordertrli_tbs_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordertrli_tbs_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_gunowak_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_gunowak_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=29491,crit=31129,min=0,max=32768 1635735600000000000\nmetric,label='tbs_gunowak_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2058,min=0,max=32768 1635735600000000000\nmetric,label='tbs_data4_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_data4_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_data4_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_err_data_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_err_data_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_err_data_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_err_index_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_err_index_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_err_index_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index03_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index03_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index03_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index04_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index04_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index04_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_cic_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_cic_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_cic_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index51_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index51_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index51_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_leander_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_leander_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_leander_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_imadvisor_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.12,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_imadvisor_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=186,warn=138240,crit=145920,min=0,max=153600 1635735600000000000\nmetric,label='tbs_imadvisor_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1024,min=0,max=153600 1635735600000000000\nmetric,label='tbs_crm_bcl_index_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_crm_bcl_index_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_crm_bcl_index_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_eds_discover_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_eds_discover_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_eds_discover_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_logmgridx_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_logmgridx_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_logmgridx_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrl01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ordtrl01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrl01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrl02_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ordtrl02_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrl02_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_tax_data01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_tax_data01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_tax_data01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_dashboard_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_dashboard_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=29490,crit=31128,min=0,max=32767 1635735600000000000\nmetric,label='tbs_dashboard_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=100,min=0,max=32767 1635735600000000000\nmetric,label='tbs_index02_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_index02_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_index02_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrli01_usage_pct',host=host,service=service,a=xyz,b=23,c=asd,uom=% value=0.1,warn=90,crit=95 1635735600000000000\nmetric,label='tbs_ordtrli01_usage',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=1,warn=921,crit=972,min=0,max=1024 1635735600000000000\nmetric,label='tbs_ordtrli01_alloc',host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=50,min=0,max=1024 1635735600000000000\nstate,host=host,service=service,a=xyz,b=23,c=asd value=0i 1635735600000000000\n"
	assert.Equal(t, expected, b.String())
}

func TestOutput(t *testing.T) {
	timestamp := time.Date(2021, time.November, 1, 3, 0, 0, 0, time.UTC)
	output := `foo; bar 13?!"\/!(\""), '\\///,;blub`
	outputEscaped := `foo; bar 13?!\"\\/!(\\\"\"), '\\\\///,;blub`
	b, err := parse("host", "service", 0, output, variableFlags{"a=xyz", "b=23", "c=asd"}, "/=2643MB;5948;5958;0;5968 /boot=68MB;88;93;0;98", timestamp)
	assert.Nil(t, err)

	expected := "metric,label=/,host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=2643,warn=5948,crit=5958,min=0,max=5968 1635735600000000000\nmetric,label=/boot,host=host,service=service,a=xyz,b=23,c=asd,uom=MB value=68,warn=88,crit=93,min=0,max=98 1635735600000000000\nstate,host=host,service=service,a=xyz,b=23,c=asd value=0i,output=\"" + outputEscaped + "\" 1635735600000000000\n"
	assert.Equal(t, expected, b.String())
}

func BenchmarkParse(b *testing.B) {
	for i := 0; i < b.N; i++ {
		_, _ = parse("host", "service", 0, "", variableFlags{"a=xyz", "b=23", "c=asd"}, "/=2643MB;5948;5958;0;5968", time.Now())
	}
}
